name: CI/CD Pipeline

on: [push, pull_request, workflow_dispatch]

permissions:
  # allows SonarCloud to decorate PRs with analysis results
  pull-requests: read


jobs:
  MavenTest:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'oracle'
          cache: maven

      - name: Format source code
        run: mvn formatter:format

      - name: Test with Maven
        run: mvn clean test

  SonarAnalysis:

      runs-on: ubuntu-latest

      steps:
          - name: Debug SonarCloud Sources
            run:
              ls -lR

          - name: Analyze with SonarCloud
            if: github.ref != 'refs/heads/disable-sonar-scan'

            uses: SonarSource/sonarcloud-github-action@v2.2.0

            env:
              SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            with:
              args:
                -Dsonar.projectKey=GreenCityProject_GreenCityUser21_team1
                -Dsonar.organization=greencityproject
                -Dsonar.binaries=target/classes
                -Dsonar.sources=src/main
                -Dsonar.tests=src/test
                -Dsonar.java.binaries=target/classes